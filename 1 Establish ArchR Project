 
library(parallel)
library(ggplot2)
library(pheatmap)
library(ArchR)
library(patchwork)
library(ComplexHeatmap)
library(Seurat)
library(SummarizedExperiment)
library(GenomicRanges)
library(pheatmap)
library(ggplot2)
library(ggrastr)
library(dplyr)
library(ggrepel)
library(dittoSeq)
#initialize
addArchRThreads(threads = 16)
addArchRGenome("hg38")
geneAnnotation <- getGeneAnnotation()
genomeAnnotation <- getGenomeAnnotation()



inputFiles <- c("primary1" = "/home/syb/R/20220711_SOX2/20231014_scATAC/GSE200813/primary1/fragments.tsv.gz",
                "primary2" = "/home/syb/R/20220711_SOX2/20231014_scATAC/GSE200813/primary2/fragments.tsv.gz",
                "primary3" = "/home/syb/R/20220711_SOX2/20231014_scATAC/GSE200813/primary3/fragments.tsv.gz",
                "liver_m1" = "/home/syb/R/20220711_SOX2/20231014_scATAC/GSE200813/liver_m1/fragments.tsv.gz",
                "liver_m2" = "/home/syb/R/20220711_SOX2/20231014_scATAC/GSE200813/liver_m2/fragments.tsv.gz",
                "liver_m3" = "/home/syb/R/20220711_SOX2/20231014_scATAC/GSE200813/liver_m3/fragments.tsv.gz")


# Creating Arrow files with the specified parameters
addArchRThreads(threads =16)
ArrowFiles <- createArrowFiles(
  inputFiles = inputFiles,
  sampleNames = names(inputFiles),
  filterTSS = 4, # This parameter does not need to be too high, can be adjusted later
  filterFrags = 1000,
  addTileMat = TRUE,
  addGeneScoreMat = TRUE # GeneActivity(GeneScore, similar to expression)  Default: TSS Â±2k
)

## project
addArchRThreads(threads =12)
doubScores <- addDoubletScores(
  input = ArrowFiles,
  k = 10, #Refers to how many cells near a "pseudo-doublet" to count.
  knnMethod = "UMAP", #Refers to the embedding to use for nearest neighbor search with doublet projection.
  LSIMethod = 1
)

projHeme1 <- ArchRProject(
  ArrowFiles = ArrowFiles, 
  outputDirectory = "projHeme1",
  copyArrows = TRUE, 
  #This is recommened so that if you modify the Arrow files you have an original copy for later usage.
)
projHeme1 
table(projHeme1 @cellColData$Sample) # Cell Number

saveArchRProject(ArchRProj = projHeme1, outputDirectory = "Save-ProjHeme1", load = FALSE)
